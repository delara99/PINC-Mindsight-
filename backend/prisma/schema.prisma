generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =======================
// Core / Multi-tenancy
// =======================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  plan        PlanType @default(FREE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  assessments AssessmentModel[]

  invitations Invitation[]
  creditSolicitations CreditSolicitation[]
  jobProfiles JobProfile[]
  siteSettings SiteSettings[]
  bigFiveConfigs BigFiveConfig[]

  @@map("tenants")
}

enum PlanType {
  FREE
  STARTER
  ENTERPRISE
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  name        String?
  role        Role     @default(MEMBER)
  status      UserStatus @default(pending)
  
  // Diferenciação PF/PJ
  userType    UserType @default(INDIVIDUAL)
  cpf         String?  @unique
  cnpj        String?  @unique
  companyName String?
  phone       String?
  
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  
  assignments AssessmentAssignment[]
  solicitations CreditSolicitation[]
  
  credits     Int      @default(0)

  // Connection relations
  connectionsSent     Connection[]         @relation("UserA")
  connectionsReceived Connection[]         @relation("UserB")
  cancelledConnections Connection[]        @relation("CancelledBy")
  
  requestsSent     ConnectionRequest[] @relation("Sender")
  requestsReceived ConnectionRequest[] @relation("Receiver")
  connectionSettings  ConnectionSharingSetting[]
  connectionMessages  ConnectionMessage[]
  createdInviteLinks  ConnectionInviteLink[] @relation("InviteLinkCreator")
  usedInviteLinks     ConnectionInviteLink[] @relation("InviteLinkUsedBy")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastActivityAt DateTime? @map("last_activity_at")

  @@map("users")
}

enum Role {
  SUPER_ADMIN
  TENANT_ADMIN
  SPECIALIST
  MEMBER
}

enum UserType {
  INDIVIDUAL  // Pessoa Física
  COMPANY     // Pessoa Jurídica
}

enum UserStatus {
  active
  pending
  inactive
}

// =======================
// Assessment Domain
// =======================

model AssessmentModel {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        AssessmentType
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  questions   Question[]
  assignments AssessmentAssignment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("assessment_models")
}

enum AssessmentType {
  BIG_FIVE
  DISC
  CUSTOM
  TECHNICAL
}

model Question {
  id                String   @id @default(uuid())
  text              String
  assessmentModelId String
  assessmentModel   AssessmentModel @relation(fields: [assessmentModelId], references: [id])
  
  traitKey          String?  // e.g., 'OPENNESS', 'EXTRAVERSION'
  weight            Float    @default(1.0)
  
  createdAt         DateTime @default(now())
  responses         AssessmentResponse[]

  @@map("questions")
}

// =======================
// Auxiliary
// =======================

model Invitation {
  id        String   @id @default(uuid())
  email     String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  token     String   @unique
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  
  @@map("invitations")
}

// Atribuição de avaliação para usuário
model AssessmentAssignment {
  id           String   @id @default(uuid())
  
  assessmentId String
  userId       String
  status       String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  assignedAt   DateTime @default(now())
  completedAt  DateTime?
  
  feedback     String?  @db.Text
  feedbackAt   DateTime?

  assessment AssessmentModel @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses  AssessmentResponse[]
  result     AssessmentResult?

  @@map("assessment_assignments")
  @@index([assessmentId])
  @@index([userId])
}

// Respostas individuais do usuário
model AssessmentResponse {
  id           String   @id @default(uuid())
  assignmentId String
  questionId   String
  answer       Int      // 1-5 (Likert scale)
  createdAt    DateTime @default(now())

  assignment AssessmentAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  question   Question             @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("assessment_responses")
  @@index([assignmentId])
  @@index([questionId])
}

// Resultado calculado da avaliação
model AssessmentResult {
  id           String   @id @default(uuid())
  assignmentId String   @unique
  scores       Json     // { "OPENNESS": 4.2, "CONSCIENTIOUSNESS": 3.8, ... }
  createdAt    DateTime @default(now())

  assignment AssessmentAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@map("assessment_results")
}

enum AssignmentStatus {
  IN_PROGRESS
  COMPLETED
}

model CreditSolicitation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    SolicitationStatus @default(PENDING)
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("credit_solicitations")
}


enum SolicitationStatus {
  PENDING
  APPROVED
  REJECTED
}

// =======================
// Advanced Reporting (Premium)
// =======================

model JobProfile {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  
  // JSON: { "OPENNESS": 4.5, "EXTRAVERSION": 4.0 }
  idealScores Json
  
  // Margem de tolerância padrão (ex: 0.5)
  tolerance   Float    @default(0.5)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("job_profiles")
}

model InterpretationRule {
  id          String   @id @default(uuid())
  
  // Qual traço está sendo analisado (ex: "OPENNESS")
  traitKey    String
  
  // Intervalo de pontuação (ex: 0.0 a 2.5)
  minScore    Float
  maxScore    Float
  
  // Texto gerado
  text        String   @db.Text
  
  // Categoria da interpretação
  category    RuleCategory @default(GENERAL)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("interpretation_rules")
}

enum RuleCategory {
    GENERAL
    STRENGTH
    RISK
    LEADERSHIP_STYLE
    COMMUNICATION_STYLE
}

// =======================
// Social & Networking ("Minhas Conexões")
// =======================

model Connection {
  id        String           @id @default(uuid())
  userAId   String
  userBId   String
  status    ConnectionStatus @default(ACTIVE)

  // Admin management fields
  cancelledBy         String?   @map("cancelled_by")
  cancelledAt         DateTime? @map("cancelled_at")
  cancellationReason  String?   @map("cancellation_reason")
  adminNotes          String?   @db.Text @map("admin_notes")

  userA User @relation("UserA", fields: [userAId], references: [id])
  userB User @relation("UserB", fields: [userBId], references: [id])
  cancelledByUser User? @relation("CancelledBy", fields: [cancelledBy], references: [id])

  messages        ConnectionMessage[]
  sharingSettings ConnectionSharingSetting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userAId, userBId])
  @@map("connections")
}

model ConnectionRequest {
  id         String        @id @default(uuid())
  senderId   String
  receiverId String
  status     RequestStatus @default(PENDING)
  message    String?       @db.Text
  requiresAdminApproval Boolean @default(false)
  approvedByAdminId String?

  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("connection_requests")
}

model ConnectionSharingSetting {
  id           String @id @default(uuid())
  connectionId String
  userId       String // Owner of these settings

  shareInventories     Boolean @default(false)
  shareFeedbacks       Boolean @default(false)
  shareQuestionnaires  Boolean @default(false)
  shareActivityHistory Boolean @default(false)

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, userId])
  @@map("connection_sharing_settings")
}

model ConnectionMessage {
  id           String      @id @default(uuid())
  connectionId String
  senderId     String
  content      String      @db.Text
  type         MessageType @default(TEXT)
  readAt       DateTime?

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  sender     User       @relation(fields: [senderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("connection_messages")
}

enum ConnectionStatus {
  ACTIVE
  BLOCKED
  CANCELLED
}

model ConnectionInviteLink {
  id        String           @id @default(uuid())
  creatorId String
  token     String           @unique
  status    InviteLinkStatus @default(ACTIVE)
  usedById  String?
  expiresAt DateTime?

  creator User  @relation("InviteLinkCreator", fields: [creatorId], references: [id])
  usedBy  User? @relation("InviteLinkUsedBy", fields: [usedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("connection_invite_links")
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
  PENDING_ADMIN_APPROVAL
}

enum InviteLinkStatus {
  ACTIVE
  USED
  EXPIRED
}

enum MessageType {
  TEXT
  SYSTEM
  ADMIN
}

// =======================
// CMS / Site Settings
// =======================

model SiteSettings {
  id        String   @id @default(uuid())
  tenantId  String?  @map("tenant_id")
  
  // Hero Section
  heroTitle       String  @default("Descubra os Talentos Ocultos") @map("hero_title") @db.VarChar(200)
  heroSubtitle    String  @default("na Sua Equipe") @map("hero_subtitle") @db.VarChar(200)
  heroDescription String? @map("hero_description") @db.Text
  heroBadge       String? @default("NOVA VERSÃO 2.0") @map("hero_badge") @db.VarChar(100)
  heroBgColor     String  @default("#EC1B8E") @map("hero_bg_color") @db.VarChar(20)
  heroTextColor   String  @default("#FFFFFF") @map("hero_text_color") @db.VarChar(20)
  
  // CTA Buttons
  primaryButtonText String  @default("Ver Demonstração") @map("primary_button_text") @db.VarChar(100)
  primaryButtonLink String  @default("/demo") @map("primary_button_link") @db.VarChar(200)
  secondaryButtonText String? @default("Conhecer Recursos") @map("secondary_button_text") @db.VarChar(100)
  secondaryButtonLink String? @default("/features") @map("secondary_button_link") @db.VarChar(200)
  
  // Theme
  primaryColor   String @default("#EC1B8E") @map("primary_color") @db.VarChar(20)
  secondaryColor String @default("#F7F7F7") @map("secondary_color") @db.VarChar(20)
  accentColor    String @default("#FFC107") @map("accent_color") @db.VarChar(20)
  
  // Features (JSON Array)
  features Json @default("[]")
  
  // Pricing Plans (JSON Array)
  pricingPlans Json @default("[]") @map("pricing_plans")
  
  // Visibility Flags
  showFeatures Boolean @default(true) @map("show_features")
  showPricing  Boolean @default(true) @map("show_pricing")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  
  @@map("site_settings")
}

// =======================
// Big Five Configuration
// =======================

model BigFiveConfig {
  id        String   @id @default(uuid())
  tenantId  String
  isActive  Boolean  @default(true)
  name      String   @default("Configuração Padrão")
  
  // Interpretação de Scores (faixas)
  veryLowMax     Int  @default(20)   // 0-20 = Muito Baixo
  lowMax         Int  @default(40)   // 21-40 = Baixo
  averageMax     Int  @default(60)   // 41-60 = Médio
  highMax        Int  @default(80)   // 61-80 = Alto
  // 81-100 = Muito Alto
  
  // Branding do Relatório
  companyLogo     String?  @db.Text
  reportHeader    String?  @db.Text
  reportFooter    String?  @db.Text
  primaryColor    String   @default("#d11c9e")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  traits   BigFiveTraitConfig[]
  
  @@map("bigfive_configs")
}

model BigFiveTraitConfig {
  id       String @id @default(uuid())
  configId String
  
  traitKey   String
  name       String
  icon       String
  weight     Float   @default(1.0)
  
  description  String @db.Text
  veryLowText  String @db.Text
  lowText      String @db.Text
  averageText  String @db.Text
  highText     String @db.Text
  veryHighText String @db.Text
  
  config BigFiveConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  facets BigFiveFacetConfig[]
  
  @@map("bigfive_trait_configs")
}

model BigFiveFacetConfig {
  id       String @id @default(uuid())
  traitId  String
  
  facetKey    String
  name        String
  weight      Float   @default(1.0)
  description String  @db.Text
  
  trait BigFiveTraitConfig @relation(fields: [traitId], references: [id], onDelete: Cascade)
  
  @@map("bigfive_facet_configs")
}

model BigFiveRecommendation {
  id       String @id @default(uuid())
  configId String
  traitKey String
  
  scoreRange  String
  title       String
  description String @db.Text
  icon        String
  order       Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("bigfive_recommendations")
}
